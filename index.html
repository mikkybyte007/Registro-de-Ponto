<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Ponto Pessoal - Miquéias</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Adição para PWA: Link para o manifest.json -->
    <link rel="manifest" href="/Registro-de-Ponto/manifest.json">
    <!-- Adição para PWA: Ícone para iOS (Safari) -->
    <link rel="apple-touch-icon" href="/Registro-de-Ponto/apple-touch-icon.png">

    <style>
        :root {
            /* Cores para o tema claro */
            --bg-color-light: #f0f2f5; /* Fundo geral */
            --text-color-light: #333; /* Texto principal */
            --card-bg-light: #ffffff; /* Fundo de cards/containers */
            --border-color-light: #e0e0e0; /* Bordas de elementos */
            --shadow-light: rgba(0, 0, 0, 0.08); /* Sombra suave */
            --input-bg-light: #fdfdfd; /* Fundo de inputs */

            /* Cores para o tema escuro */
            --bg-color-dark: #1e1e1e;
            --text-color-dark: #f0f0f0;
            --card-bg-dark: #2a2a2a;
            --border-color-dark: #3a3a3a;
            --shadow-dark: rgba(0, 0, 0, 0.3);
            --input-bg-dark: #222222;

            /* Cores primárias e secundárias (macOS inspired) */
            --primary-color: #007aff; /* Azul vibrante */
            --primary-color-hover: #005bb5;
            --secondary-color-light: #e9ecef; /* Cinza claro para botões secundários */
            --secondary-color-dark: #4a4a4a; /* Cinza escuro para botões secundários */

            /* Cores de status */
            --positive-balance-color: #34c759; /* Verde para saldo positivo */
            --negative-balance-color: #ff3b30; /* Vermelho para saldo negativo */
            --neutral-color: #888; /* Cor neutra para texto secundário */
            --excel-icon-color: #28a745; /* Verde para ícone do Excel */
            --clock-icon-color: #ff9500; /* Laranja para ícone de relógio */
            --briefcase-icon-color: #5ac8fa; /* Azul claro para ícone de horas trabalhadas */
            --trash-icon-color: #ff3b30; /* Vermelho para ícone de lixeira */


            /* Estilo macOS */
            --macos-border-radius: 12px; /* Cantos mais arredondados */
            --macos-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Sombra mais pronunciada, mas suave */
            --macos-border: 1px solid var(--border-color-light); /* Borda discreta */
            --macos-transition: all 0.2s ease-in-out; /* Transição suave para animações */
        }

        /* Reset básico e box-sizing */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            padding: 25px; /* Aumenta padding para um visual mais espaçoso */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            transition: var(--macos-transition);
            background-color: var(--bg-color-light);
            color: var(--text-color-light);
            line-height: 1.6; /* Melhora a legibilidade */
            font-size: 16px; /* Tamanho base da fonte */
        }

        body.dark-mode {
            background-color: var(--bg-color-dark);
            color: var(--text-color-dark);
        }

        .container {
            background-color: var(--card-bg-light);
            border: var(--macos-border);
            border-radius: var(--macos-border-radius);
            box-shadow: var(--macos-shadow);
            padding: 30px; /* Aumenta padding */
            width: 100%;
            max-width: 700px; /* Ajusta max-width para melhor visualização */
            margin-bottom: 25px; /* Aumenta margin-bottom */
            transition: var(--macos-transition);
        }

        body.dark-mode .container {
            background-color: var(--card-bg-dark);
            border-color: var(--border-color-dark);
            box-shadow: 0 4px 12px var(--shadow-dark);
        }

        h1 {
            text-align: center;
            color: var(--text-color-light);
            margin-bottom: 30px; /* Aumenta margin-bottom */
            font-size: 2.2rem; /* Tamanho da fonte mais alegre */
            font-weight: 700; /* Mais negrito */
            letter-spacing: -0.02em; /* Espaçamento sutil */
        }

        body.dark-mode h1 {
            color: var(--text-color-dark);
        }

        h2 {
            font-size: 1.8rem; /* Tamanho da fonte mais alegre */
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
            color: var(--text-color-light);
        }

        body.dark-mode h2 {
            color: var(--text-color-dark);
        }

        .form-group {
            margin-bottom: 18px; /* Aumenta margin-bottom */
            display: flex;
            flex-direction: column;
            gap: 10px; /* Aumenta espaçamento entre label e input */
        }

        .form-group label {
            font-weight: 600; /* Mais negrito */
            color: var(--text-color-light);
            font-size: 1.05rem; /* Ajusta tamanho da fonte */
            display: flex;
            align-items: center;
            gap: 8px; /* Espaçamento entre ícone e texto */
        }

        body.dark-mode .form-group label {
            color: var(--text-color-dark);
        }

        .form-group input[type="date"],
        .form-group input[type="time"],
        .form-group input[type="number"] {
            padding: 14px; /* Aumenta padding */
            border: 1px solid var(--border-color-light);
            border-radius: var(--macos-border-radius);
            font-size: 1.05rem;
            background-color: var(--input-bg-light); /* Fundo de input dedicado */
            color: var(--text-color-light);
            transition: var(--macos-transition);
            -webkit-appearance: none;
            min-width: 130px;
        }

        body.dark-mode .form-group input {
            background-color: var(--input-bg-dark);
            border-color: var(--border-color-dark);
            color: var(--text-color-dark);
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.25); /* Sombra de foco mais pronunciada */
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 15px; /* Aumenta gap */
            margin-top: 25px; /* Aumenta margin-top */
            justify-content: center;
        }

        @media (min-width: 480px) {
            .button-group {
                flex-direction: row;
                flex-wrap: wrap; /* Permite quebra de linha em telas intermediárias */
            }
            .button-group button {
                flex: 1 1 auto; /* Botões se ajustam e ocupam espaço */
                max-width: calc(50% - 7.5px); /* Dois botões por linha com gap */
            }
            .button-group button:nth-child(3) { /* Se houver 3 botões, o terceiro fica em nova linha ou centralizado */
                max-width: 100%;
            }
        }
        @media (min-width: 600px) { /* Para 3 botões em linha */
            .button-group button {
                max-width: calc(33.333% - 10px); /* Três botões por linha com gap */
            }
        }


        button {
            padding: 16px 25px; /* Aumenta padding */
            border: none;
            border-radius: var(--macos-border-radius);
            font-size: 1.1rem;
            cursor: pointer;
            transition: var(--macos-transition);
            font-weight: 600;
            width: 100%;
            box-shadow: var(--macos-shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px; /* Espaçamento entre ícone e texto do botão */
        }

        button.primary {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.2);
        }

        button.primary:hover {
            background-color: var(--primary-color-hover);
            box-shadow: 0 6px 16px rgba(0, 122, 255, 0.3);
            transform: translateY(-2px); /* Animação sutil */
        }

        button.secondary {
            background-color: var(--secondary-color-light);
            color: var(--text-color-light);
            border: 1px solid var(--border-color-light); /* Borda para secundário */
        }

        body.dark-mode button.secondary {
            background-color: var(--secondary-color-dark);
            border-color: var(--border-color-dark);
            color: var(--text-color-dark);
        }

        button.secondary:hover {
            opacity: 0.9;
            transform: translateY(-1px); /* Animação sutil */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        #data-entries {
            margin-top: 30px; /* Aumenta margin-top */
            width: 100%;
        }

        #data-entries h2 {
            margin-bottom: 25px; /* Aumenta margin-bottom */
        }

        .entry-card {
            background-color: var(--card-bg-light);
            border: var(--macos-border);
            border-radius: var(--macos-border-radius);
            padding: 20px; /* Aumenta padding */
            margin-bottom: 15px; /* Aumenta margin-bottom */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-start;
            box-shadow: var(--macos-shadow);
            transition: var(--macos-transition);
            position: relative; /* Para posicionar o botão de lixeira */
        }

        body.dark-mode .entry-card {
            background-color: var(--card-bg-dark);
            border-color: var(--border-color-dark);
            box-shadow: 0 4px 12px var(--shadow-dark);
        }

        .entry-card:hover {
            transform: translateY(-3px); /* Animação ao passar o mouse */
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }

        .entry-info {
            flex-grow: 1;
            color: var(--text-color-light);
            font-size: 0.9rem; /* Fonte menor para caber no celular */
            margin-bottom: 15px; /* Espaçamento entre info e ações */
            line-height: 1.4; /* Melhora a legibilidade do texto */
            word-break: break-word;
            width: 100%; /* Ocupa largura total */
        }

        body.dark-mode .entry-info {
            color: var(--text-color-dark);
        }

        .entry-info p {
            display: flex;
            align-items: center;
            gap: 8px; /* Espaçamento entre ícone e texto */
            margin-bottom: 5px; /* Espaçamento entre as linhas de info */
            flex-wrap: wrap; /* Permite quebra de linha para o conteúdo */
        }

        .entry-info p strong {
            font-weight: 600;
            min-width: 120px; /* Alinha os dois pontos */
            display: inline-block;
            white-space: nowrap; /* Impede que o label quebre */
        }

        /* Estilo para os valores de tempo dentro dos parágrafos */
        .entry-info p span, .entry-info p time {
            white-space: nowrap; /* Impede que os horários quebrem */
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .entry-actions {
            position: absolute; /* Posiciona o botão de lixeira */
            top: 15px;
            right: 15px;
            width: auto; /* Não ocupa largura total */
        }

        .entry-actions button {
            background: none;
            border: none;
            color: var(--trash-icon-color); /* Vermelho para lixeira */
            cursor: pointer;
            font-size: 1.4rem; /* Aumenta tamanho do ícone */
            padding: 8px;
            border-radius: var(--macos-border-radius);
            width: auto;
            box-shadow: none;
            transition: var(--macos-transition);
        }

        .entry-actions button:hover {
            background-color: rgba(255, 59, 48, 0.15);
            transform: scale(1.1); /* Animação de escala */
        }

        .theme-toggle {
            position: static;
            margin-bottom: 25px;
            background-color: var(--card-bg-light);
            border: var(--macos-border);
            border-radius: var(--macos-border-radius);
            padding: 12px 18px; /* Aumenta padding */
            cursor: pointer;
            font-size: 1rem;
            color: var(--text-color-light);
            transition: var(--macos-transition);
            width: 100%;
            max-width: 700px; /* Alinha com os containers */
            text-align: center;
            box-shadow: var(--macos-shadow);
            font-weight: 500;
        }

        body.dark-mode .theme-toggle {
            background-color: var(--card-bg-dark);
            border-color: var(--border-color-dark);
            color: var(--text-color-dark);
        }

        .theme-toggle:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        @media (min-width: 768px) {
            .theme-toggle {
                position: absolute;
                top: 25px;
                right: 25px;
                width: auto;
                max-width: none;
            }
            .entry-card {
                flex-direction: row;
                align-items: center;
                padding-right: 60px; /* Espaço para o botão de lixeira */
            }
            .entry-info {
                margin-bottom: 0;
            }
            .entry-actions {
                position: static; /* Volta a ser estático para alinhamento */
                margin-left: auto; /* Empurra para a direita */
            }
        }

        #summary {
            margin-top: 30px;
            padding: 25px; /* Aumenta padding */
            background-color: var(--card-bg-light);
            border: var(--macos-border);
            border-radius: var(--macos-border-radius);
            box-shadow: var(--macos-shadow);
            width: 100%;
            max-width: 700px;
            color: var(--text-color-light);
            transition: var(--macos-transition);
            text-align: center; /* Centraliza o texto do resumo */
        }

        body.dark-mode #summary {
            background-color: var(--card-bg-dark);
            border-color: var(--border-color-dark);
            box-shadow: 0 4px 12px var(--shadow-dark);
            color: var(--text-color-dark);
        }

        #summary p {
            margin-bottom: 10px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center; /* Centraliza o conteúdo do parágrafo */
            gap: 8px;
        }

        #summary p strong {
            font-weight: 700;
        }

        .footer {
            margin-top: 40px; /* Aumenta margem */
            font-size: 0.9rem;
            color: var(--neutral-color);
            text-align: center;
            padding-bottom: 20px; /* Espaçamento no final da página */
        }

        body.dark-mode .footer {
            color: #bbb;
        }

        /* Cores para saldo */
        .positive-balance {
            color: var(--positive-balance-color);
            font-weight: 700;
        }

        .negative-balance {
            color: var(--negative-balance-color);
            font-weight: 700;
        }

        /* Cores para ícones específicos */
        .fa-calendar-alt { color: var(--primary-color); } /* Azul */
        .fa-clock { color: var(--clock-icon-color); } /* Laranja */
        .fa-hourglass-half { color: #8e8e93; } /* Cinza */
        .fa-briefcase { color: var(--briefcase-icon-color); } /* Azul claro */
        .fa-exchange-alt { color: #ffcc00; } /* Amarelo */
        .fa-wallet { color: #34c759; } /* Verde */
        .fa-plus-circle { color: white; } /* Branco no botão primário */
        .fa-file-excel { color: var(--excel-icon-color); } /* Verde para Excel */
        .fa-trash-alt { color: var(--trash-icon-color); } /* Vermelho para lixeira */
        .fa-sun { color: #ffcc00; } /* Amarelo para sol */
        .fa-moon { color: #8e8e93; } /* Cinza para lua */

        /* Ajuste para ícones dentro de botões secundários no modo escuro */
        body.dark-mode button.secondary .fa-file-excel { color: var(--excel-icon-color); }
        body.dark-mode button.secondary .fa-trash-alt { color: var(--trash-icon-color); }
        body.dark-mode button.secondary .fa-sun { color: var(--text-color-dark); } /* Cor do texto do botão */
        body.dark-mode button.secondary .fa-moon { color: var(--text-color-dark); } /* Cor do texto do botão */

    </style>
</head>
<body>
    <button id="themeToggle" class="theme-toggle">Modo Escuro</button>

    <div class="container">
        <h1>Controle de Ponto Pessoal</h1>

        <div class="form-group">
            <label for="data"><i class="fas fa-calendar-alt"></i> Data:</label>
            <input type="date" id="data" required>
        </div>

        <div class="form-group">
            <label for="entradaPrevista"><i class="fas fa-clock"></i> Entrada Prevista:</label>
            <input type="time" id="entradaPrevista" value="08:00" required>
        </div>

        <div class="form-group">
            <label for="saidaPrevista"><i class="fas fa-clock"></i> Saída Prevista:</label>
            <input type="time" id="saidaPrevista" value="17:00" required>
        </div>

        <div class="form-group">
            <label for="entradaReal"><i class="fas fa-clock"></i> Entrada Real:</label>
            <input type="time" id="entradaReal" required>
        </div>

        <div class="form-group">
            <label for="saidaReal"><i class="fas fa-clock"></i> Saída Real:</label>
            <input type="time" id="saidaReal" required>
        </div>

        <div class="form-group">
            <label for="editTolerance"><i class="fas fa-hourglass-half"></i> Tolerância de Edição (minutos):</label>
            <input type="number" id="editTolerance" value="10" min="0">
        </div>

        <div class="button-group">
            <button id="addEntryBtn" class="primary"><i class="fas fa-plus-circle"></i> Adicionar Registro</button>
            <button id="generateExcelBtn" class="secondary"><i class="fas fa-file-excel" style="color: var(--excel-icon-color);"></i> Gerar Excel</button>
            <button id="clearEntriesBtn" class="secondary"><i class="fas fa-trash-alt" style="color: var(--trash-icon-color);"></i> Limpar Todos</button>
        </div>
    </div>

    <div id="data-entries" class="container">
        <h2>Registros de Ponto</h2>
        <div id="entriesList">
            <!-- Registros serão inseridos aqui -->
        </div>
    </div>

    <div id="summary" class="container">
        <h2>Resumo do Banco de Horas</h2>
        <p><i class="fas fa-wallet"></i> Total de Horas Devidas/Extras Acumuladas: <strong id="totalBancoHoras">00:00</strong></p>
    </div>

    <footer class="footer">
        Autor: Miquéias Lima
    </footer>

    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script>
        // --- Constantes e Variáveis Globais ---
        const ENTRADA_PREVISTA_PADRAO = "08:00";
        const SAIDA_PREVISTA_PADRAO = "17:00";

        let entries = [];
        let editToleranceMinutes = 10; // Valor padrão para a tolerância de edição

        // --- Elementos do DOM ---
        const dataInput = document.getElementById('data');
        const entradaPrevistaInput = document.getElementById('entradaPrevista');
        const saidaPrevistaInput = document.getElementById('saidaPrevista');
        const entradaRealInput = document.getElementById('entradaReal');
        const saidaRealInput = document.getElementById('saidaReal');
        const editToleranceInput = document.getElementById('editTolerance');
        const addEntryBtn = document.getElementById('addEntryBtn');
        const clearEntriesBtn = document.getElementById('clearEntriesBtn');
        const generateExcelBtn = document.getElementById('generateExcelBtn');
        const entriesList = document.getElementById('entriesList');
        const totalBancoHorasSpan = document.getElementById('totalBancoHoras');
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;

        // --- Funções de Utilitário de Tempo ---
        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function minutesToTime(totalMinutes) {
            if (totalMinutes === 0) return "00:00";
            const sign = totalMinutes < 0 ? "-" : "";
            totalMinutes = Math.abs(totalMinutes);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${sign}${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }

        function calculateTimeDifference(start, end) {
            const startMinutes = timeToMinutes(start);
            const endMinutes = timeToMinutes(end);
            return endMinutes - startMinutes;
        }

        // --- Funções de Gerenciamento de Registros ---
        function loadEntries() {
            const savedEntries = localStorage.getItem('pointEntries');
            if (savedEntries) {
                entries = JSON.parse(savedEntries);
            }
            const savedTolerance = localStorage.getItem('editTolerance');
            if (savedTolerance !== null) {
                editToleranceMinutes = parseInt(savedTolerance);
                editToleranceInput.value = editToleranceMinutes;
            }
            renderEntries();
        }

        function saveEntries() {
            localStorage.setItem('pointEntries', JSON.stringify(entries));
            localStorage.setItem('editTolerance', editToleranceMinutes);
        }

        function renderEntries() {
            entriesList.innerHTML = '';
            let totalBancoHorasAcumulado = 0;

            entries.sort((a, b) => new Date(a.data) - new Date(b.data));

            entries.forEach((entry, index) => {
                const entradaPrevistaMin = timeToMinutes(entry.entradaPrevista);
                const saidaPrevistaMin = timeToMinutes(entry.saidaPrevista);
                const entradaRealMin = timeToMinutes(entry.entradaReal);
                const saidaRealMin = timeToMinutes(entry.saidaReal);

                const horasTrabalhadasDiaMin = calculateTimeDifference(entry.entradaReal, entry.saidaReal);

                let horasDevidasExtrasDiaMin = 0;

                // Lógica de tolerância para entrada
                if (entradaRealMin < entradaPrevistaMin - editToleranceMinutes) {
                    horasDevidasExtrasDiaMin += (entradaPrevistaMin - editToleranceMinutes) - entradaRealMin;
                } else if (entradaRealMin > entradaPrevistaMin + editToleranceMinutes) {
                    horasDevidasExtrasDiaMin -= (entradaRealMin - (entradaPrevistaMin + editToleranceMinutes));
                }

                // Lógica de tolerância para saída
                if (saidaRealMin > saidaPrevistaMin + editToleranceMinutes) {
                    horasDevidasExtrasDiaMin += saidaRealMin - (saidaPrevistaMin + editToleranceMinutes);
                } else if (saidaRealMin < saidaPrevistaMin - editToleranceMinutes) {
                    horasDevidasExtrasDiaMin -= (saidaPrevistaMin - editToleranceMinutes) - saidaRealMin;
                }

                totalBancoHorasAcumulado += horasDevidasExtrasDiaMin;

                entry.horasTrabalhadasDia = minutesToTime(horasTrabalhadasDiaMin);
                entry.horasDevidasExtrasDia = minutesToTime(horasDevidasExtrasDiaMin);
                entry.bancoHorasAcumulado = minutesToTime(totalBancoHorasAcumulado);

                const entryCard = document.createElement('div');
                entryCard.classList.add('entry-card');
                entryCard.innerHTML = `
                    <div class="entry-info">
                        <p><strong><i class="fas fa-calendar-alt"></i> Data:</strong> <span>${new Date(entry.data + 'T00:00:00').toLocaleDateString('pt-BR')}</span></p>
                        <p><strong><i class="fas fa-clock"></i> Previsto:</strong> <span>${entry.entradaPrevista} - ${entry.saidaPrevista}</span></p>
                        <p><strong><i class="fas fa-clock"></i> Real:</strong> <span>${entry.entradaReal} - ${entry.saidaReal}</span></p>
                        <p><strong><i class="fas fa-hourglass-half"></i> Tolerância:</strong> <span>${editToleranceMinutes} min</span></p>
                        <p><strong><i class="fas fa-briefcase"></i> Trabalhadas:</strong> <span>${entry.horasTrabalhadasDia}</span></p>
                        <p><strong><i class="fas fa-exchange-alt"></i> Banco Dia:</strong> <span class="${horasDevidasExtrasDiaMin < 0 ? 'negative-balance' : (horasDevidasExtrasDiaMin > 0 ? 'positive-balance' : '')}">${entry.horasDevidasExtrasDia}</span></p>
                        <p><strong><i class="fas fa-wallet"></i> Banco Acumulado:</strong> <span class="${totalBancoHorasAcumulado < 0 ? 'negative-balance' : (totalBancoHorasAcumulado > 0 ? 'positive-balance' : '')}">${entry.bancoHorasAcumulado}</span></p>
                    </div>
                    <div class="entry-actions">
                        <button data-index="${index}" aria-label="Remover registro"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                entriesList.appendChild(entryCard);
            });

            totalBancoHorasSpan.textContent = minutesToTime(totalBancoHorasAcumulado);
            totalBancoHorasSpan.className = totalBancoHorasAcumulado < 0 ? 'negative-balance' : (totalBancoHorasAcumulado > 0 ? 'positive-balance' : '');

            saveEntries();
        }

        function addEntry() {
            const data = dataInput.value;
            const entradaPrevista = entradaPrevistaInput.value || ENTRADA_PREVISTA_PADRAO;
            const saidaPrevista = saidaPrevistaInput.value || SAIDA_PREVISTA_PADRAO;
            const entradaReal = entradaRealInput.value;
            const saidaReal = saidaRealInput.value;

            if (!data || !entradaReal || !saidaReal) {
                alert('Por favor, preencha a data, entrada real e saída real.');
                return;
            }

            const newEntry = {
                data,
                entradaPrevista,
                saidaPrevista,
                entradaReal,
                saidaReal,
                horasTrabalhadasDia: '',
                horasDevidasExtrasDia: '',
                bancoHorasAcumulado: ''
            };
            entries.push(newEntry);
            renderEntries();
            // Opcional: Limpa os campos de entrada, exceto a data para facilitar entradas sequenciais
            // entradaInput.value = ENTRADA_PREVISTA;
            // saidaInput.value = SAIDA_PREVISTA;
        }

        function deleteEntry(index) {
            if (confirm('Tem certeza que deseja remover este registro?')) {
                entries.splice(index, 1);
                renderEntries();
            }
        }

        function clearAllEntries() {
            if (confirm('Tem certeza que deseja limpar TODOS os registros? Esta ação é irreversível.')) {
                entries = [];
                renderEntries();
                localStorage.removeItem('pointEntries');
            }
        }

        // --- Geração de Excel ---
        function generateExcel() {
            if (entries.length === 0) {
                alert('Não há registros para gerar o Excel.');
                return;
            }

            const dataForExcel = entries.map(entry => ({
                'Data': new Date(entry.data + 'T00:00:00').toLocaleDateString('pt-BR'),
                'Entrada Prevista': entry.entradaPrevista,
                'Saída Prevista': entry.saidaPrevista,
                'Entrada Real': entry.entradaReal,
                'Saída Real': entry.saidaReal,
                'Tolerância Aplicada (min)': editToleranceMinutes,
                'Horas Trabalhadas (Dia)': entry.horasTrabalhadasDia,
                'Horas Devidas/Extras (Dia)': entry.horasDevidasExtrasDia,
                'Banco de Horas Acumulado': entry.bancoHorasAcumulado
            }));

            const ws = XLSX.utils.json_to_sheet(dataForExcel);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Controle de Ponto");

            const today = new Date();
            const currentDay = today.getDate();
            let startMonth, startYear, endMonth, endYear;

            if (currentDay > 20) {
                startMonth = today.getMonth();
                startYear = today.getFullYear();
                endMonth = (startMonth + 1) % 12;
                endYear = (endMonth === 0) ? startYear + 1 : startYear;
            } else {
                endMonth = today.getMonth();
                endYear = today.getFullYear();
                startMonth = (endMonth === 0) ? 11 : endMonth - 1;
                startYear = (endMonth === 0) ? endYear - 1 : endYear;
            }

            const startDate = new Date(startYear, startMonth, 21);
            const endDate = new Date(endYear, endMonth, 20);

            const fileName = `Controle_Ponto_${startDate.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' }).replace(/\s/g, '_')}_a_${endDate.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' }).replace(/\s/g, '_')}.xlsx`;

            XLSX.writeFile(wb, fileName);
        }

        // --- Gerenciamento de Tema (Claro/Escuro) ---
        function applyTheme(isDarkMode) {
            if (isDarkMode) {
                body.classList.add('dark-mode');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i> Modo Claro';
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.remove('dark-mode');
                themeToggle.innerHTML = '<i class="fas fa-moon"></i> Modo Escuro';
                localStorage.setItem('theme', 'light');
            }
        }

        function toggleTheme() {
            const isDarkMode = body.classList.contains('dark-mode');
            applyTheme(!isDarkMode);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                applyTheme(true);
            } else {
                applyTheme(false); // Padrão para claro
            }
        }

        // --- Event Listeners ---
        addEntryBtn.addEventListener('click', addEntry);
        clearEntriesBtn.addEventListener('click', clearAllEntries);
        generateExcelBtn.addEventListener('click', generateExcel);
        entriesList.addEventListener('click', (event) => {
            if (event.target.closest('button') && event.target.closest('button').dataset.index) {
                deleteEntry(parseInt(event.target.closest('button').dataset.index));
            }
        });
        themeToggle.addEventListener('click', toggleTheme);

        editToleranceInput.addEventListener('change', (event) => {
            const newTolerance = parseInt(event.target.value);
            if (!isNaN(newTolerance) && newTolerance >= 0) {
                editToleranceMinutes = newTolerance;
                renderEntries();
            } else {
                alert('Por favor, insira um número válido para a tolerância (maior ou igual a 0).');
                editToleranceInput.value = editToleranceMinutes;
            }
        });

        // --- Inicialização ---
        document.addEventListener('DOMContentLoaded', () => {
            dataInput.valueAsDate = new Date();
            loadTheme();
            loadEntries();
        });

        // --- Registro do Service Worker (para PWA) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/Registro-de-Ponto/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registrado com sucesso:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Falha no registro do ServiceWorker:', error);
                    });
            });
        }
    </script>
</body>
</html>
